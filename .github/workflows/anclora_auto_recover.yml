name: âš“ Anclora | Auto Recover Main

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *" # Cada noche a las 03:00 UTC

jobs:
  recover:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ”¹ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§­ Detect divergence between development and main
        id: divergence-check
        run: |
          git fetch origin
          DEV_COMMITS=$(git rev-list --left-right --count origin/development...origin/main | cut -f1)
          echo "DEV_COMMITS=$DEV_COMMITS" >> $GITHUB_OUTPUT
          if [ "$DEV_COMMITS" -gt 0 ]; then
            echo "Detected divergence; triggering recovery"
            echo "needs_recovery=true" >> $GITHUB_OUTPUT
          else
            echo "No divergence detected"
            echo "needs_recovery=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”„ Restore main from development
        if: ${{ steps.divergence-check.outputs.needs_recovery == 'true' }}
        shell: pwsh
        id: recovery-step
        run: |
          $ErrorActionPreference = "Stop"
          Write-Host "ğŸ”„ Starting recovery process..."
          Write-Host "ğŸ“Š DEV_COMMITS: ${{ steps.divergence-check.outputs.DEV_COMMITS }}"

          if (Test-Path "scripts/anclora_git_recover_cli.ps1") {
            try {
              ./scripts/anclora_git_recover_cli.ps1 `
                -Mode mainFromBranch `
                -Source "development" `
                -AutoConfirm $true
              Write-Host "âœ… Recovery completed successfully"
              echo "recovery_status=success" >> $env:GITHUB_OUTPUT
            }
            catch {
              Write-Host "âŒ Recovery failed: $($_.Exception.Message)"
              Write-Host "Stack trace: $($_.ScriptStackTrace)"
              echo "recovery_status=failed" >> $env:GITHUB_OUTPUT
              exit 1
            }
          } else {
            Write-Host "âŒ Error: Recovery script not found at scripts/anclora_git_recover_cli.ps1"
            Write-Host "ğŸ“ Current directory: $(Get-Location)"
            Write-Host "ğŸ“‚ Available scripts:"
            if (Test-Path "scripts") {
              Get-ChildItem "scripts" | ForEach-Object { Write-Host "  - $($_.Name)" }
            } else {
              Write-Host "  No scripts directory found"
            }
            echo "recovery_status=script_not_found" >> $env:GITHUB_OUTPUT
            exit 1
          }

      - name: âœ… Summary
        shell: pwsh
        run: |
          Write-Host "ğŸ•’ Recovery process completed at $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC') -UFormat '%z'"

          $needsRecovery = "${{ steps.divergence-check.outputs.needs_recovery }}"
          $devCommits = "${{ steps.divergence-check.outputs.DEV_COMMITS }}"
          $recoveryStatus = if ("${{ steps.recovery-step.outcome }}") { "${{ steps.recovery-step.outcome }}" } else { "not_executed" }

          if ($needsRecovery -eq "false") {
            Write-Host "âœ… No divergence detected between development and main branches"
            Write-Host "ğŸ“Š Branch status: development and main are in sync"
          } else {
            Write-Host "ğŸ”„ Divergence detected: $devCommits commits ahead"
            if ($recoveryStatus -eq "success") {
              Write-Host "âœ… Recovery: Main branch has been synchronized with development"
            } else {
              Write-Host "âŒ Recovery: Process failed or was not executed"
              Write-Host "ğŸ“‹ Check previous steps for detailed error information"
            }
          }

          Write-Host ""
          Write-Host "ğŸ“ˆ Process Summary:"
          Write-Host "  â€¢ Development commits ahead: $devCommits"
          Write-Host "  â€¢ Recovery needed: $needsRecovery"
          Write-Host "  â€¢ Recovery status: $recoveryStatus"
