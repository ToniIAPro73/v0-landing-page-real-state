name: âš“ Anclora | Auto Recover Main Branch

on:
  schedule:
    # Ejecuta todos los dÃ­as a las 03:00 UTC
    - cron: "0 3 * * *"
  workflow_dispatch: # Permite ejecuciÃ³n manual desde GitHub Actions

jobs:
  recover-main:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Permite commits y push
    steps:
      - name: ğŸ”¹ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Clona todo el historial de Git

      - name: âš™ï¸ Set up PowerShell
        run: |
          # Install PowerShell on Ubuntu
          wget -q "https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb"
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: ğŸ§­ Detect current date and create backup branch
        id: backup
        run: |
          echo "ğŸ“¦ Creando copia de seguridad de main..."
          TS=$(date +"%Y%m%d-%H%M%S")
          BACKUP_BRANCH="backup/main-${TS}"
          git fetch origin
          git checkout main
          git pull origin main
          git checkout -b "$BACKUP_BRANCH"
          git push origin "$BACKUP_BRANCH"
          echo "âœ… Backup branch created: $BACKUP_BRANCH"

      - name: ğŸ“¥ Ensure recovery script exists
        run: |
          if [ ! -f "scripts/anclora_git_recover_cli.ps1" ]; then
            echo "Script no encontrado, descargando..."
            mkdir -p scripts
            curl -L -o scripts/anclora_git_recover_cli.ps1 \
              https://raw.githubusercontent.com/ToniIAPro73/v0-landing-page-real-state/main/scripts/anclora_git_recover_cli.ps1
          fi

      - name: ğŸ”„ Restore main branch from Claude branch
        shell: pwsh
        run: |
          ./scripts/anclora_git_recover_cli.ps1 `
            -Mode mainFromBranch `
            -Source "claude/playa-viva-landing-page-011CUsPXiqxuxCxUpCqy83GB" `
            -AutoConfirm $true

      - name: âœ… Verification summary
        run: |
          echo "ğŸ§­ Verificando Ãºltima sincronizaciÃ³n..."
          git checkout main
          git status
          echo "Ãšltimo commit:"
          git log -1 --oneline
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "âœ… Main restaurado y backup remoto creado correctamente."
