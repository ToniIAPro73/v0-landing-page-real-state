name: âš“ Anclora | Auto Sync Main â†” Claude

on:
  schedule:
    # Ejecuta todos los dÃ­as a las 02:30 UTC (antes del auto-recover)
    - cron: "30 2 * * *"
  workflow_dispatch:

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      SOURCE_BRANCH: claude/playa-viva-landing-page-011CUsPXiqxuxCxUpCqy83GB
      TARGET_BRANCH: main

    steps:
      - name: ðŸ”¹ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ§­ Confirm environment
        run: |
          echo "ðŸ” Syncing $SOURCE_BRANCH â†” $TARGET_BRANCH"
          git fetch origin
          git branch -r

      - name: ðŸ’¾ Create backup branches before sync
        run: |
          TS=$(date +"%Y%m%d-%H%M%S")
          git fetch origin
          git checkout ${{ env.TARGET_BRANCH }}
          git pull origin ${{ env.TARGET_BRANCH }}
          git branch "backup/${{ env.TARGET_BRANCH }}-$TS"
          git push origin "backup/${{ env.TARGET_BRANCH }}-$TS"

          git checkout ${{ env.SOURCE_BRANCH }}
          git pull origin ${{ env.SOURCE_BRANCH }}
          git branch "backup/${{ env.SOURCE_BRANCH }}-$TS"
          git push origin "backup/${{ env.SOURCE_BRANCH }}-$TS"

          echo "âœ… Backups creados: backup/${{ env.TARGET_BRANCH }}-$TS y backup/${{ env.SOURCE_BRANCH }}-$TS"

      - name: ðŸ§© Ensure sync script exists
        run: |
          if [ ! -f "scripts/sync_all.ps1" ]; then
            echo "Descargando sync_all.ps1 desde remoto..."
            mkdir -p scripts
            curl -L -o scripts/sync_all.ps1 \
              https://raw.githubusercontent.com/ToniIAPro73/v0-landing-page-real-state/main/scripts/sync_all.ps1
          fi

      - name: ðŸ”„ Run bidirectional sync script
        shell: bash
        run: |
          # Install PowerShell if not available
          if ! command -v pwsh &> /dev/null; then
            echo "Instalando PowerShell..."
            # Use more reliable PowerShell installation for GitHub Actions
            sudo apt-get update -qq
            sudo apt-get install -y -qq wget apt-transport-https software-properties-common
            wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
            sudo dpkg -i packages-microsoft-prod.deb
            sudo apt-get update -qq
            sudo apt-get install -y -qq powershell
          fi

          # Verify PowerShell installation
          pwsh --version

          # Run PowerShell script
          pwsh ./scripts/sync_all.ps1
        continue-on-error: false

      - name: âœ… Commit & push verification
        run: |
          echo "ðŸ§­ Estado final:"
          git status
          echo "Ãšltimos commits:"
          git log --oneline -5 --decorate

      - name: ðŸ“œ Generate summary log
        run: |
          echo "ðŸ—“ï¸ $(date '+%Y-%m-%d %H:%M:%S')" > sync_log.txt
          echo "âœ”ï¸ SincronizaciÃ³n completada entre $SOURCE_BRANCH y $TARGET_BRANCH" >> sync_log.txt
          echo "-------------------------------------------" >> sync_log.txt
          git log -3 --oneline >> sync_log.txt
          cat sync_log.txt

      - name: ðŸ“¤ Upload sync log as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sync_log
          path: sync_log.txt
